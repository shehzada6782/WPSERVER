<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAHAN WP SERVER</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #25D366;
            --secondary: #128C7E;
            --dark: #075E54;
            --light: #DCF8C6;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: var(--primary) !important;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(45deg, var(--dark), var(--secondary));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-whatsapp {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .btn-whatsapp:hover {
            background: linear-gradient(45deg, var(--secondary), var(--dark));
            color: white;
        }
        
        .status-connected {
            color: var(--primary);
            font-weight: bold;
        }
        
        .status-disconnected {
            color: #dc3545;
            font-weight: bold;
        }
        
        .progress {
            height: 10px;
            border-radius: 10px;
        }
        
        .session-card {
            border-left: 4px solid var(--primary);
        }
        
        .task-card {
            border-left: 4px solid #ffc107;
        }
        
        .heartbeat {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .stats-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .code-display {
            background: #f8f9fa;
            border: 2px dashed #25D366;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            letter-spacing: 3px;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 20px;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(45deg, var(--dark), var(--secondary));
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .nav-tabs .nav-link {
            color: var(--dark);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fab fa-whatsapp"></i> AAHAN HERE
            </a>
            <span class="navbar-text">
                <small class="text-success heartbeat">
                    <i class="fas fa-heart"></i> UNLIMITED UPTIME
                </small>
            </span>
        </div>
    </nav>

    <div class="container my-4">
        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card text-white">
                    <div class="card-body text-center">
                        <h3><i class="fas fa-users"></i></h3>
                        <h5 id="totalSessions">0</h5>
                        <small>Active Sessions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white">
                    <div class="card-body text-center">
                        <h3><i class="fas fa-tasks"></i></h3>
                        <h5 id="totalTasks">0</h5>
                        <small>Active Tasks</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white">
                    <div class="card-body text-center">
                        <h3><i class="fas fa-paper-plane"></i></h3>
                        <h5 id="totalMessages">0</h5>
                        <small>Messages Sent</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-white">
                    <div class="card-body text-center">
                        <h3><i class="fas fa-heartbeat"></i></h3>
                        <h5 id="uptime">0s</h5>
                        <small>System Uptime</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab">
                    <i class="fas fa-mobile-alt"></i> Sessions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="send-tab" data-bs-toggle="tab" data-bs-target="#send" type="button" role="tab">
                    <i class="fas fa-paper-plane"></i> Send Messages
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                    <i class="fas fa-tasks"></i> Active Tasks
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Sessions Tab -->
            <div class="tab-pane fade show active" id="sessions" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-plus-circle"></i> Pair New Number
                            </div>
                            <div class="card-body">
                                <form id="pairForm">
                                    <div class="mb-3">
                                        <label class="form-label">Your User ID</label>
                                        <input type="text" class="form-control" id="userId" placeholder="Enter unique user ID" required>
                                        <div class="form-text">This identifies your sessions</div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">WhatsApp Number</label>
                                        <input type="text" class="form-control" id="phoneNumber" placeholder="e.g., 919876543210" required>
                                        <div class="form-text">Country code + number (without +)</div>
                                    </div>
                                    <button type="submit" class="btn btn-whatsapp w-100">
                                        <i class="fas fa-qrcode"></i> Get Pairing Code
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-qrcode"></i> Pairing Code
                            </div>
                            <div class="card-body text-center">
                                <div id="pairingResult" style="display: none;">
                                    <div class="code-display mb-3">
                                        <span id="pairingCode">-----</span>
                                    </div>
                                    <p class="text-muted" id="pairingMessage">
                                        Use this code in WhatsApp ‚Üí Linked Devices
                                    </p>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> 
                                        Session ID: <code id="sessionIdDisplay"></code>
                                    </div>
                                </div>
                                <div id="pairingWaiting" class="text-center">
                                    <p class="text-muted">Enter details above to get pairing code</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list"></i> Your Sessions</span>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadUserSessions()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="sessionsList">
                                    <p class="text-muted text-center">No active sessions</p>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-users"></i> Group Management
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Select Session</label>
                                    <select class="form-select" id="groupsSessionSelect">
                                        <option value="">Select a connected session</option>
                                    </select>
                                </div>
                                <button class="btn btn-whatsapp w-100" onclick="loadGroups()">
                                    <i class="fas fa-sync-alt"></i> Load Groups
                                </button>
                                <div id="groupsList" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Send Messages Tab -->
            <div class="tab-pane fade" id="send" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-cogs"></i> Message Configuration
                            </div>
                            <div class="card-body">
                                <form id="sendForm">
                                    <div class="mb-3">
                                        <label class="form-label">Your User ID</label>
                                        <input type="text" class="form-control" id="sendUserId" placeholder="Same as pairing user ID" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Select Session</label>
                                        <select class="form-select" id="sessionSelect" required>
                                            <option value="">Select a connected session</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Target Type</label>
                                        <select class="form-select" id="targetType" required>
                                            <option value="group">Group</option>
                                            <option value="individual">Individual Number</option>
                                        </select>
                                    </div>

                                    <div class="mb-3" id="groupTargetDiv">
                                        <label class="form-label">Select Group</label>
                                        <select class="form-select" id="groupSelect">
                                            <option value="">Select a group</option>
                                        </select>
                                    </div>

                                    <div class="mb-3" id="individualTargetDiv" style="display: none;">
                                        <label class="form-label">Target Number</label>
                                        <input type="text" class="form-control" id="individualTarget" placeholder="e.g., 919876543210">
                                        <div class="form-text">With country code, without +</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Message File</label>
                                        <input type="file" class="form-control" id="messageFile" accept=".txt" required>
                                        <div class="form-text">Text file with one message per line</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Delay (seconds)</label>
                                        <input type="number" class="form-control" id="delaySec" value="2" min="1" required>
                                        <div class="form-text">Delay between messages in seconds</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Message Prefix (Optional)</label>
                                        <input type="text" class="form-control" id="prefix" placeholder="e.g., Hello,">
                                    </div>

                                    <button type="submit" class="btn btn-whatsapp w-100">
                                        <i class="fas fa-paper-plane"></i> Start Sending Messages
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-rocket"></i> Quick Start Task
                            </div>
                            <div class="card-body">
                                <div id="taskStartResult"></div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-info-circle"></i> Instructions
                            </div>
                            <div class="card-body">
                                <h6>üìù Message File Format:</h6>
                                <ul class="small">
                                    <li>Create a .txt file</li>
                                    <li>One message per line</li>
                                    <li>No empty lines</li>
                                    <li>Max 10,000 messages</li>
                                </ul>
                                
                                <h6>‚è∞ Recommended Delays:</h6>
                                <ul class="small">
                                    <li>Groups: 3-5 seconds</li>
                                    <li>Individuals: 1-2 seconds</li>
                                    <li>Avoid rate limits</li>
                                </ul>
                                
                                <h6>üõë Stopping Tasks:</h6>
                                <p class="small">Go to Active Tasks tab to stop any running task</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Tasks Tab -->
            <div class="tab-pane fade" id="tasks" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-tasks"></i> Active Tasks</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadUserTasks()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="tasksList">
                            <p class="text-muted text-center">No active tasks</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-user"></i> User Management
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Your User ID</label>
                                    <input type="text" class="form-control" id="statsUserId" placeholder="Enter your user ID">
                                </div>
                                <button class="btn btn-whatsapp w-100" onclick="loadUserStats()">
                                    <i class="fas fa-chart-bar"></i> Get Stats
                                </button>
                                <div id="userStats" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-trash"></i> Cleanup
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    This will delete all your sessions and tasks
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Your User ID</label>
                                    <input type="text" class="form-control" id="cleanupUserId" placeholder="Enter your user ID">
                                </div>
                                <button class="btn btn-danger w-100" onclick="cleanupSessions()">
                                    <i class="fas fa-trash"></i> Cleanup All My Sessions
                                </button>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-heartbeat"></i> System Health
                            </div>
                            <div class="card-body">
                                <button class="btn btn-outline-info w-100" onclick="checkHealth()">
                                    <i class="fas fa-stethoscope"></i> Check System Health
                                </button>
                                <div id="healthStatus" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let currentUserId = '';
        let refreshIntervals = {};

        // Initialize
        $(document).ready(function() {
            console.log('üöÄ WhatsApp Bulk Sender Initialized');
            startUptimeCounter();
            setInterval(updateStats, 10000); // Update stats every 10 seconds
        });

        // Uptime Counter
        function startUptimeCounter() {
            let seconds = 0;
            setInterval(() => {
                seconds++;
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                $('#uptime').text(`${hours}h ${minutes}m ${secs}s`);
            }, 1000);
        }

        // Update Stats
        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                $('#totalSessions').text(data.stats.totalSessions || 0);
                $('#totalTasks').text(data.stats.activeTasks || 0);
                $('#totalMessages').text(data.stats.totalTasks || 0);
            } catch (error) {
                console.error('Stats update failed:', error);
            }
        }

        // Pair New Number
        $('#pairForm').on('submit', async function(e) {
            e.preventDefault();
            
            const userId = $('#userId').val().trim();
            const phoneNumber = $('#phoneNumber').val().replace(/[^0-9]/g, '');
            
            if (!userId || !phoneNumber) {
                alert('Please fill all fields');
                return;
            }
            
            currentUserId = userId;
            
            try {
                const response = await fetch(`${API_BASE}/code?number=${phoneNumber}&userId=${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                $('#pairingCode').text(data.pairingCode);
                $('#pairingMessage').text(data.message);
                $('#sessionIdDisplay').text(data.sessionId);
                $('#pairingWaiting').hide();
                $('#pairingResult').show();
                
                // Load sessions after pairing
                loadUserSessions();
                
            } catch (error) {
                alert('Connection failed: ' + error.message);
            }
        });

        // Load User Sessions
        async function loadUserSessions() {
            const userId = $('#userId').val().trim() || currentUserId;
            if (!userId) {
                alert('Please enter User ID first');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user-sessions?userId=${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    $('#sessionsList').html('<p class="text-danger">Error: ' + data.error + '</p>');
                    return;
                }
                
                if (data.sessions.length === 0) {
                    $('#sessionsList').html('<p class="text-muted text-center">No active sessions</p>');
                    updateSessionDropdowns([]);
                    return;
                }
                
                let html = '';
                data.sessions.forEach(session => {
                    const statusClass = session.registered ? 'status-connected' : 'status-disconnected';
                    const statusText = session.registered ? 'Connected' : 'Disconnected';
                    
                    html += `
                        <div class="card session-card mb-2">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">${session.number}</h6>
                                        <small class="text-muted">Session: ${session.sessionId}</small>
                                        <br>
                                        <span class="${statusClass}">
                                            <i class="fas fa-circle"></i> ${statusText}
                                        </span>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSession('${session.sessionId}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                ${session.registered ? `
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-users"></i> ${session.totalGroups} groups | 
                                            <i class="fas fa-clock"></i> ${new Date(session.pairedAt).toLocaleString()}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                $('#sessionsList').html(html);
                updateSessionDropdowns(data.sessions);
                
            } catch (error) {
                $('#sessionsList').html('<p class="text-danger">Failed to load sessions</p>');
            }
        }

        // Update Session Dropdowns
        function updateSessionDropdowns(sessions) {
            const connectedSessions = sessions.filter(s => s.registered);
            
            // Update all session dropdowns
            $('#sessionSelect, #groupsSessionSelect').html(`
                <option value="">Select a connected session</option>
                ${connectedSessions.map(s => 
                    `<option value="${s.sessionId}">${s.number} (${s.sessionId})</option>`
                ).join('')}
            `);
        }

        // Load Groups
        async function loadGroups() {
            const sessionId = $('#groupsSessionSelect').val();
            const userId = $('#userId').val().trim() || currentUserId;
            
            if (!sessionId || !userId) {
                alert('Please select session and enter User ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups?sessionId=${sessionId}&userId=${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    $('#groupsList').html('<div class="alert alert-danger">' + data.error + '</div>');
                    return;
                }
                
                let html = '<h6>Your Groups:</h6>';
                if (data.groups.length === 0) {
                    html += '<p class="text-muted">No groups found</p>';
                } else {
                    data.groups.forEach(group => {
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <h6 class="mb-1">${group.name}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-users"></i> ${group.participants} members | 
                                        <i class="fas fa-lock"></i> ${group.isLocked ? 'Locked' : 'Open'}
                                    </small>
                                    <br>
                                    <small><code>${group.id}</code></small>
                                </div>
                            </div>
                        `;
                    });
                }
                
                $('#groupsList').html(html);
                updateGroupDropdown(data.groups);
                
            } catch (error) {
                $('#groupsList').html('<div class="alert alert-danger">Failed to load groups</div>');
            }
        }

        // Update Group Dropdown
        function updateGroupDropdown(groups) {
            $('#groupSelect').html(`
                <option value="">Select a group</option>
                ${groups.map(g => 
                    `<option value="${g.id}">${g.name} (${g.participants} members)</option>`
                ).join('')}
            `);
        }

        // Target Type Toggle
        $('#targetType').on('change', function() {
            if ($(this).val() === 'group') {
                $('#groupTargetDiv').show();
                $('#individualTargetDiv').hide();
            } else {
                $('#groupTargetDiv').hide();
                $('#individualTargetDiv').show();
            }
        });

        // Send Messages
        $('#sendForm').on('submit', async function(e) {
            e.preventDefault();
            
            const userId = $('#sendUserId').val().trim();
            const sessionId = $('#sessionSelect').val();
            const targetType = $('#targetType').val();
            const delaySec = $('#delaySec').val();
            const prefix = $('#prefix').val();
            const messageFile = $('#messageFile')[0].files[0];
            
            let target = '';
            let groupId = '';
            
            if (targetType === 'group') {
                groupId = $('#groupSelect').val();
                if (!groupId) {
                    alert('Please select a group');
                    return;
                }
            } else {
                target = $('#individualTarget').val();
                if (!target) {
                    alert('Please enter target number');
                    return;
                }
            }
            
            if (!messageFile) {
                alert('Please select message file');
                return;
            }
            
            const formData = new FormData();
            formData.append('userId', userId);
            formData.append('sessionId', sessionId);
            formData.append('targetType', targetType);
            formData.append('delaySec', delaySec);
            formData.append('prefix', prefix);
            formData.append('messageFile', messageFile);
            
            if (target) formData.append('target', target);
            if (groupId) formData.append('groupId', groupId);
            
            try {
                const response = await fetch(`${API_BASE}/send-message`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    $('#taskStartResult').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i> ${data.error}
                        </div>
                    `);
                } else {
                    $('#taskStartResult').html(`
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> ${data.message}
                            <br><br>
                            <strong>Task ID:</strong> <code>${data.taskId}</code>
                            <br>
                            <strong>Messages:</strong> ${data.totalMessages}
                            <br><br>
                            <button class="btn btn-sm btn-whatsapp" onclick="loadUserTasks()">
                                View in Active Tasks
                            </button>
                        </div>
                    `);
                    
                    // Reset form
                    $('#sendForm')[0].reset();
                    loadUserTasks();
                }
                
            } catch (error) {
                $('#taskStartResult').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> Failed to start task: ${error.message}
                    </div>
                `);
            }
        });

        // Load User Tasks
        async function loadUserTasks() {
            const userId = $('#sendUserId').val().trim() || $('#userId').val().trim() || currentUserId;
            if (!userId) return;
            
            try {
                const response = await fetch(`${API_BASE}/user-tasks?userId=${userId}`);
                const data = await response.json();
                
                if (data.error || data.tasks.length === 0) {
                    $('#tasksList').html('<p class="text-muted text-center">No active tasks</p>');
                    return;
                }
                
                let html = '';
                data.tasks.forEach(task => {
                    const progress = task.progress || 0;
                    const statusClass = task.isSending ? 'bg-success' : 'bg-warning';
                    const statusText = task.isSending ? 'Running' : 'Completed';
                    
                    html += `
                        <div class="card task-card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">${task.taskId}</h6>
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </div>
                                
                                <div class="progress mb-2">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${progress}%" 
                                         aria-valuenow="${progress}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        ${progress}%
                                    </div>
                                </div>
                                
                                <div class="row text-center">
                                    <div class="col">
                                        <small>Sent</small>
                                        <br>
                                        <strong>${task.sentMessages}/${task.totalMessages}</strong>
                                    </div>
                                    <div class="col">
                                        <small>Progress</small>
                                        <br>
                                        <strong>${progress}%</strong>
                                    </div>
                                    <div class="col">
                                        <small>Status</small>
                                        <br>
                                        <strong>${statusText}</strong>
                                    </div>
                                </div>
                                
                                ${task.isSending ? `
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-danger w-100" 
                                                onclick="stopTask('${task.taskId}')">
                                            <i class="fas fa-stop"></i> Stop Task
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                $('#tasksList').html(html);
                
            } catch (error) {
                $('#tasksList').html('<p class="text-danger">Failed to load tasks</p>');
            }
        }

        // Stop Task
        async function stopTask(taskId) {
            const userId = $('#sendUserId').val().trim() || $('#userId').val().trim() || currentUserId;
            
            if (!confirm('Are you sure you want to stop this task?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/stop-task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `taskId=${taskId}&userId=${userId}`
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Task stopped successfully');
                    loadUserTasks();
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                alert('Failed to stop task: ' + error.message);
            }
        }

        // Delete Session
        async function deleteSession(sessionId) {
            const userId = $('#userId').val().trim() || currentUserId;
            
            if (!confirm('Are you sure you want to delete this session?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/delete-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `sessionId=${sessionId}&userId=${userId}`
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Session deleted successfully');
                    loadUserSessions();
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                alert('Failed to delete session: ' + error.message);
            }
        }

        // Load User Stats
        async function loadUserStats() {
            const userId = $('#statsUserId').val().trim();
            if (!userId) {
                alert('Please enter User ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/user-stats?userId=${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    $('#userStats').html('<div class="alert alert-danger">' + data.error + '</div>');
                    return;
                }
                
                const stats = data.stats;
                $('#userStats').html(`
                    <div class="alert alert-info">
                        <h6><i class="fas fa-user"></i> User Statistics</h6>
                        <hr>
                        <div class="row text-center">
                            <div class="col-6">
                                <strong>${stats.totalSessions}</strong>
                                <br>
                                <small>Sessions</small>
                            </div>
                            <div class="col-6">
                                <strong>${stats.activeSessions}</strong>
                                <br>
                                <small>Active</small>
                            </div>
                        </div>
                        <div class="row text-center mt-2">
                            <div class="col-6">
                                <strong>${stats.totalTasks}</strong>
                                <br>
                                <small>Total Tasks</small>
                            </div>
                            <div class="col-6">
                                <strong>${stats.totalMessagesSent}</strong>
                                <br>
                                <small>Messages Sent</small>
                            </div>
                        </div>
                        <hr>
                        <small>
                            <i class="fas fa-calendar"></i> User since: ${new Date(stats.userSince).toLocaleDateString()}
                            <br>
                            <i class="fas fa-clock"></i> Last active: ${new Date(stats.lastActive).toLocaleString()}
                        </small>
                    </div>
                `);
                
            } catch (error) {
                $('#userStats').html('<div class="alert alert-danger">Failed to load stats</div>');
            }
        }

        // Cleanup Sessions
        async function cleanupSessions() {
            const userId = $('#cleanupUserId').val().trim();
            if (!userId) {
                alert('Please enter User ID');
                return;
            }
            
            if (!confirm('This will delete ALL your sessions and tasks. Continue?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/cleanup-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `sessionId=all&userId=${userId}`
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Cleanup completed: ' + data.message);
                    loadUserSessions();
                    loadUserTasks();
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                alert('Cleanup failed: ' + error.message);
            }
        }

        // Check Health
        async function checkHealth() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                $('#healthStatus').html(`
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> System Healthy</h6>
                        <hr>
                        <strong>Status:</strong> ${data.status}
                        <br>
                        <strong>Uptime:</strong> ${Math.round(data.uptime)} seconds
                        <br>
                        <strong>Memory:</strong> ${Math.round(data.memory.used / 1024 / 1024)}MB / ${Math.round(data.memory.total / 1024 / 1024)}MB
                        <br>
                        <strong>Users:</strong> ${data.stats.totalUsers}
                        <br>
                        <strong>Sessions:</strong> ${data.stats.totalSessions}
                        <br>
                        <strong>Tasks:</strong> ${data.stats.totalTasks}
                    </div>
                `);
                
            } catch (error) {
                $('#healthStatus').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> Health check failed: ${error.message}
                    </div>
                `);
            }
        }

        // Auto-refresh when switching to tasks tab
        $('#tasks-tab').on('click', function() {
            loadUserTasks();
        });

        // Auto-refresh when switching to sessions tab  
        $('#sessions-tab').on('click', function() {
            loadUserSessions();
        });
    </script>
</body>
</html>
