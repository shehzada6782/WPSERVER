<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAHAN WP SERVER - WhatsApp Bulk Sender</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #25D366;
            --secondary: #128C7E;
            --dark: #075E54;
            --light: #DCF8C6;
            --accent: #34B7F1;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark) 0%, var(--secondary) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.8rem;
            color: white !important;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
            background: rgba(255,255,255,0.95);
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--dark) 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .btn-whatsapp {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-whatsapp:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A24 100%);
            border: none;
            border-radius: 10px;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #FFD93D 0%, #FF9A3D 100%);
            border: none;
            border-radius: 10px;
            color: #333;
        }
        
        .status-connected {
            color: var(--primary);
            font-weight: bold;
        }
        
        .status-disconnected {
            color: #FF6B6B;
            font-weight: bold;
        }
        
        .status-connecting {
            color: #FFD93D;
            font-weight: bold;
        }
        
        .qr-code {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 15px 0;
            border: 3px solid var(--light);
        }
        
        .user-stats {
            background: linear-gradient(135deg, var(--accent) 0%, #25D366 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .nav-tabs {
            border-bottom: 3px solid var(--light);
        }
        
        .nav-tabs .nav-link {
            color: var(--dark);
            font-weight: 600;
            border: none;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            padding: 12px 25px;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(37, 211, 102, 0.25);
        }
        
        .refresh-btn {
            background: var(--accent);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            transform: rotate(180deg);
            background: var(--secondary);
        }
        
        .session-card {
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        .session-card:hover {
            border-left-color: var(--accent);
        }
        
        .task-card {
            border-left: 5px solid var(--accent);
        }
        
        .progress {
            height: 12px;
            border-radius: 10px;
            background: #e9ecef;
        }
        
        .progress-bar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border-radius: 10px;
        }
        
        .group-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .group-item:hover {
            background-color: var(--light);
            transform: translateX(5px);
        }
        
        .group-item.selected {
            background-color: var(--light);
            border-left: 4px solid var(--primary);
        }
        
        @media (max-width: 768px) {
            .stat-number {
                font-size: 2rem;
            }
            
            .nav-tabs .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fab fa-whatsapp me-2"></i>
                AAHAN WP SERVER
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item">
                    <span class="navbar-text">
                        <i class="fas fa-user me-1"></i>
                        <span id="currentUser">User</span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- User Stats -->
        <div class="user-stats">
            <div class="row text-center">
                <div class="col-md-3 col-6 mb-3">
                    <h3 class="stat-number" id="totalSessions">0</h3>
                    <div class="stat-label"><i class="fas fa-mobile-alt me-1"></i>Connected Sessions</div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <h3 class="stat-number" id="activeTasks">0</h3>
                    <div class="stat-label"><i class="fas fa-tasks me-1"></i>Active Tasks</div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <h3 class="stat-number" id="totalMessages">0</h3>
                    <div class="stat-label"><i class="fas fa-paper-plane me-1"></i>Messages Sent</div>
                </div>
                <div class="col-md-3 col-6 mb-3">
                    <h3 class="stat-number" id="userSince">-</h3>
                    <div class="stat-label"><i class="fas fa-user-clock me-1"></i>User Since</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab">
                    <i class="fas fa-mobile-alt me-2"></i>WhatsApp Sessions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="send-tab" data-bs-toggle="tab" data-bs-target="#send" type="button" role="tab">
                    <i class="fas fa-paper-plane me-2"></i>Send Messages
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                    <i class="fas fa-tasks me-2"></i>Message Tasks
                </button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Sessions Tab -->
            <div class="tab-pane fade show active" id="sessions" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card session-card">
                            <div class="card-header">
                                <i class="fas fa-qrcode me-2"></i>Connect WhatsApp Number
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Your User ID</label>
                                    <input type="text" class="form-control" id="userId" placeholder="Enter your unique user ID" value="user_${Math.floor(1000 + Math.random() * 9000)}">
                                    <div class="form-text">This ID helps us manage your sessions securely</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">WhatsApp Number</label>
                                    <input type="text" class="form-control" id="phoneNumber" placeholder="e.g., 919876543210">
                                    <div class="form-text">Enter number with country code (without + sign)</div>
                                </div>
                                <button class="btn btn-whatsapp w-100" onclick="pairNumber()" id="pairButton">
                                    <i class="fas fa-link me-2"></i>Connect WhatsApp
                                </button>
                            </div>
                        </div>

                        <div class="card" id="qrCard" style="display: none;">
                            <div class="card-header">
                                <i class="fas fa-qrcode me-2"></i>WhatsApp Pairing
                            </div>
                            <div class="card-body text-center">
                                <div id="pairingStatus" class="alert alert-info">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Generating pairing code...
                                </div>
                                <div class="qr-code" id="qrContainer">
                                    <!-- QR code will appear here -->
                                </div>
                                <div class="mt-3">
                                    <p class="fw-bold">How to connect:</p>
                                    <div class="text-start">
                                        <div class="d-flex mb-2">
                                            <div class="me-3"><i class="fas fa-mobile-alt text-success"></i></div>
                                            <div>Open WhatsApp on your phone</div>
                                        </div>
                                        <div class="d-flex mb-2">
                                            <div class="me-3"><i class="fas fa-cog text-success"></i></div>
                                            <div>Go to Settings → Linked Devices</div>
                                        </div>
                                        <div class="d-flex mb-2">
                                            <div class="me-3"><i class="fas fa-link text-success"></i></div>
                                            <div>Tap on "Link a Device"</div>
                                        </div>
                                        <div class="d-flex">
                                            <div class="me-3"><i class="fas fa-qrcode text-success"></i></div>
                                            <div>Scan the QR code above</div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-secondary mt-3" onclick="hideQR()">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-list me-2"></i>Your Active Sessions</span>
                                <button class="refresh-btn" onclick="loadUserSessions()" title="Refresh Sessions">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="sessionsList">
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-mobile-alt fa-3x mb-3 text-light" style="color: #e9ecef !important;"></i>
                                        <p>No WhatsApp sessions connected yet</p>
                                        <small class="text-muted">Connect your first WhatsApp account to get started</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Send Messages Tab -->
            <div class="tab-pane fade" id="send" role="tabpanel">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-cogs me-2"></i>Message Settings
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Your User ID</label>
                                    <input type="text" class="form-control" id="sendUserId" placeholder="Enter your user ID">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Select WhatsApp Session</label>
                                    <select class="form-select" id="sessionSelect">
                                        <option value="">-- Select Session --</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Send To</label>
                                    <select class="form-select" id="targetType" onchange="toggleTargetInput()">
                                        <option value="individual">Individual Number</option>
                                        <option value="group">WhatsApp Group</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="individualTargetDiv">
                                    <label class="form-label">Phone Number</label>
                                    <input type="text" class="form-control" id="targetNumber" placeholder="e.g., 919876543210">
                                </div>
                                <div class="mb-3" id="groupTargetDiv" style="display: none;">
                                    <label class="form-label">Select Group</label>
                                    <div class="group-list" id="groupsList" style="max-height: 200px; overflow-y: auto;">
                                        <div class="text-center text-muted py-3">
                                            <i class="fas fa-users fa-2x mb-2"></i>
                                            <p>Select a session first to load groups</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Message Prefix (Optional)</label>
                                    <input type="text" class="form-control" id="messagePrefix" placeholder="e.g., Hello,">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Delay Between Messages (seconds)</label>
                                    <input type="number" class="form-control" id="delaySeconds" value="2" min="1" max="60">
                                    <div class="form-text">Recommended: 2-5 seconds to avoid rate limits</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Messages File</label>
                                    <input type="file" class="form-control" id="messageFile" accept=".txt">
                                    <div class="form-text">Upload a .txt file with one message per line</div>
                                </div>
                                <button class="btn btn-success w-100" onclick="startSending()" id="sendButton">
                                    <i class="fas fa-paper-plane me-2"></i>Start Sending Messages
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-eye me-2"></i>Message Preview
                            </div>
                            <div class="card-body">
                                <div id="filePreview">
                                    <div class="text-muted text-center py-3">
                                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                                        <p>No file selected</p>
                                        <small>Upload a messages file to see preview</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <i class="fas fa-info-circle me-2"></i>Sending Status
                            </div>
                            <div class="card-body">
                                <div id="sendStatus">
                                    <div class="text-center text-muted py-2">
                                        <p>Ready to send messages</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div class="tab-pane fade" id="tasks" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-tasks me-2"></i>Your Message Tasks</span>
                                <button class="refresh-btn" onclick="loadUserTasks()" title="Refresh Tasks">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="tasksList">
                                    <div class="text-center text-muted py-5">
                                        <i class="fas fa-tasks fa-3x mb-3 text-light" style="color: #e9ecef !important;"></i>
                                        <p>No active message tasks</p>
                                        <small class="text-muted">Your message sending tasks will appear here</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentSessionId = null;
        let currentUserId = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Set user ID from input or generate random
            const userIdInput = document.getElementById('userId');
            const sendUserIdInput = document.getElementById('sendUserId');
            
            if (!userIdInput.value) {
                const randomUserId = 'user_' + Math.floor(1000 + Math.random() * 9000);
                userIdInput.value = randomUserId;
            }
            
            sendUserIdInput.value = userIdInput.value;
            currentUserId = userIdInput.value;
            document.getElementById('currentUser').textContent = currentUserId;
            
            loadUserStats();
            loadUserSessions();
            
            // Auto-refresh sessions every 30 seconds
            setInterval(loadUserSessions, 30000);
        });

        // Update user ID across all inputs
        document.getElementById('userId').addEventListener('change', function() {
            const userId = this.value;
            document.getElementById('sendUserId').value = userId;
            document.getElementById('currentUser').textContent = userId;
            currentUserId = userId;
            loadUserStats();
            loadUserSessions();
        });

        // Pair new WhatsApp number
        async function pairNumber() {
            const userId = document.getElementById('userId').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            if (!userId || !phoneNumber) {
                showAlert('Please enter both User ID and Phone Number', 'warning');
                return;
            }

            document.getElementById('qrCard').style.display = 'block';
            document.getElementById('pairingStatus').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Getting pairing code...';

            const pairButton = document.getElementById('pairButton');
            pairButton.disabled = true;
            pairButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Connecting...';

            try {
                const response = await fetch(`/code?number=${phoneNumber}&userId=${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    showAlert('Error: ' + data.error, 'danger');
                    pairButton.disabled = false;
                    pairButton.innerHTML = '<i class="fas fa-link me-2"></i>Connect WhatsApp';
                    return;
                }

                if (data.status === 'already-registered') {
                    document.getElementById('pairingStatus').innerHTML = 
                        '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>Session already registered and ready to use!</div>';
                    document.getElementById('qrContainer').innerHTML = '<div class="alert alert-info p-4">Already Connected</div>';
                    showAlert('WhatsApp session is already connected and ready!', 'success');
                    loadUserSessions();
                } else if (data.waCode) {
                    if (data.waCode.length === 8) {
                        // 8-digit code
                        document.getElementById('pairingStatus').innerHTML = 
                            '<div class="alert alert-info"><i class="fas fa-key me-2"></i>Use this 8-digit code in WhatsApp: <strong>' + data.waCode + '</strong></div>';
                        document.getElementById('qrContainer').innerHTML = `
                            <div class="p-4 bg-light rounded">
                                <div style="font-size: 2.5rem; font-weight: bold; letter-spacing: 8px; color: #25D366;">
                                    ${data.waCode}
                                </div>
                                <small class="text-muted">Enter this code in WhatsApp Linked Devices</small>
                            </div>
                        `;
                    } else {
                        // QR code
                        document.getElementById('pairingStatus').innerHTML = 
                            '<div class="alert alert-info"><i class="fas fa-qrcode me-2"></i>Scan the QR code with WhatsApp</div>';
                        document.getElementById('qrContainer').innerHTML = `
                            <div class="p-4 bg-light rounded">
                                <div style="font-family: monospace; font-weight: bold; word-break: break-all; font-size: 14px;">
                                    ${data.waCode}
                                </div>
                                <small class="text-muted">Scan this code with WhatsApp</small>
                            </div>
                        `;
                    }
                    
                    currentSessionId = data.sessionId;
                    showAlert('Pairing code received. Please complete the pairing process in WhatsApp.', 'info');
                    
                    // Check connection status periodically
                    checkConnectionStatus(data.sessionId, userId);
                }

            } catch (error) {
                showAlert('Connection error: ' + error.message, 'danger');
            } finally {
                pairButton.disabled = false;
                pairButton.innerHTML = '<i class="fas fa-link me-2"></i>Connect WhatsApp';
            }
        }

        // Check connection status
        async function checkConnectionStatus(sessionId, userId) {
            setTimeout(async () => {
                try {
                    const response = await fetch(`/user-sessions?userId=${userId}`);
                    const data = await response.json();
                    
                    const session = data.sessions.find(s => s.sessionId === sessionId);
                    if (session && session.registered) {
                        document.getElementById('pairingStatus').innerHTML = 
                            '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>WhatsApp connected successfully!</div>';
                        showAlert('WhatsApp connected successfully! You can now send messages.', 'success');
                        loadUserSessions();
                    } else {
                        checkConnectionStatus(sessionId, userId);
                    }
                } catch (error) {
                    console.error('Error checking connection:', error);
                }
            }, 3000);
        }

        // Hide QR card
        function hideQR() {
            document.getElementById('qrCard').style.display = 'none';
            loadUserSessions();
        }

        // Load user sessions
        async function loadUserSessions() {
            const userId = document.getElementById('userId').value;
            if (!userId) return;

            try {
                const response = await fetch(`/user-sessions?userId=${userId}`);
                const data = await response.json();
                
                const sessionsList = document.getElementById('sessionsList');
                const sessionSelect = document.getElementById('sessionSelect');
                
                sessionSelect.innerHTML = '<option value="">-- Select Session --</option>';
                
                if (data.sessions.length === 0) {
                    sessionsList.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-mobile-alt fa-3x mb-3 text-light" style="color: #e9ecef !important;"></i>
                            <p>No WhatsApp sessions connected yet</p>
                            <small class="text-muted">Connect your first WhatsApp account to get started</small>
                        </div>
                    `;
                    return;
                }

                let sessionsHTML = '';
                data.sessions.forEach(session => {
                    const statusClass = session.registered ? 
                        (session.isConnecting ? 'status-connecting' : 'status-connected') : 
                        'status-disconnected';
                    
                    const statusText = session.registered ? 
                        (session.isConnecting ? 'Connecting...' : 'Connected') : 
                        'Disconnected';

                    sessionsHTML += `
                        <div class="card mb-3 session-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="card-title d-flex align-items-center">
                                            <i class="fab fa-whatsapp me-2 text-success"></i>
                                            ${session.number}
                                        </h6>
                                        <p class="card-text mb-1">
                                            <span class="${statusClass}">
                                                <i class="fas fa-circle me-1" style="font-size: 0.7rem;"></i>${statusText}
                                            </span>
                                            ${session.registered ? `• ${session.totalGroups} groups available` : ''}
                                        </p>
                                        <small class="text-muted">Session ID: ${session.sessionId}</small>
                                        ${session.deviceInfo ? `
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Connected: ${new Date(session.deviceInfo.pairedAt).toLocaleString()}
                                                </small>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="d-flex">
                                        <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshGroups('${session.sessionId}')" title="Refresh Groups">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSession('${session.sessionId}')" title="Delete Session">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Add to session select dropdown
                    const option = document.createElement('option');
                    option.value = session.sessionId;
                    option.textContent = `${session.number} (${session.totalGroups} groups)`;
                    sessionSelect.appendChild(option);
                });

                sessionsList.innerHTML = sessionsHTML;
                loadUserStats();

            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        // Refresh groups for a session
        async function refreshGroups(sessionId) {
            const userId = document.getElementById('userId').value;
            
            try {
                const response = await fetch('/refresh-groups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `sessionId=${sessionId}&userId=${userId}`
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert(`Successfully refreshed ${data.total} groups`, 'success');
                    loadUserSessions();
                } else {
                    showAlert('Error refreshing groups: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Error refreshing groups:', error);
                showAlert('Error refreshing groups', 'danger');
            }
        }

        // Delete session
        async function deleteSession(sessionId) {
            const userId = document.getElementById('userId').value;
            
            if (!confirm('Are you sure you want to delete this WhatsApp session? This will disconnect the device.')) {
                return;
            }

            try {
                const response = await fetch('/delete-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `sessionId=${sessionId}&userId=${userId}`
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('WhatsApp session deleted successfully', 'success');
                    loadUserSessions();
                } else {
                    showAlert('Error deleting session: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Error deleting session:', error);
                showAlert('Error deleting session', 'danger');
            }
        }

        // Toggle target input based on type
        function toggleTargetInput() {
            const targetType = document.getElementById('targetType').value;
            const individualDiv = document.getElementById('individualTargetDiv');
            const groupDiv = document.getElementById('groupTargetDiv');
            
            if (targetType === 'individual') {
                individualDiv.style.display = 'block';
                groupDiv.style.display = 'none';
            } else {
                individualDiv.style.display = 'none';
                groupDiv.style.display = 'block';
                loadGroupsForSession();
            }
        }

        // Load groups when session is selected
        document.getElementById('sessionSelect').addEventListener('change', function() {
            loadGroupsForSession();
        });

        // Load groups for selected session
        async function loadGroupsForSession() {
            const sessionId = document.getElementById('sessionSelect').value;
            const userId = document.getElementById('sendUserId').value;
            const groupsList = document.getElementById('groupsList');
            
            if (!sessionId) {
                groupsList.innerHTML = '<div class="text-center text-muted py-3"><p>Select a session first</p></div>';
                return;
            }

            try {
                const response = await fetch(`/groups?sessionId=${sessionId}&userId=${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    groupsList.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                if (data.groups.length === 0) {
                    groupsList.innerHTML = '<div class="text-center text-muted py-3"><p>No groups found</p></div>';
                    return;
                }

                let groupsHTML = '';
                data.groups.forEach(group => {
                    groupsHTML += `
                        <div class="group-item" onclick="selectGroup(this, '${group.id}')">
                            <strong>${group.name}</strong>
                            <br>
                            <small class="text-muted">${group.participants} participants • ${group.isAnnouncement ? 'Announcement Group' : 'Standard Group'}</small>
                        </div>
                    `;
                });

                groupsList.innerHTML = groupsHTML;

            } catch (error) {
                console.error('Error loading groups:', error);
                groupsList.innerHTML = '<div class="alert alert-danger">Error loading groups</div>';
            }
        }

        // Select group
        function selectGroup(element, groupId) {
            // Remove selected class from all groups
            document.querySelectorAll('.group-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selected class to clicked group
            element.classList.add('selected');
            
            // Store selected group ID
            element.dataset.groupId = groupId;
        }

        // Preview file content
        document.getElementById('messageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('filePreview');
            
            if (!file) {
                preview.innerHTML = `
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                        <p>No file selected</p>
                        <small>Upload a messages file to see preview</small>
                    </div>
                `;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const messages = content.split('\n').filter(msg => msg.trim());
                
                preview.innerHTML = `
                    <h6>File Preview (${messages.length} messages):</h6>
                    <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        ${messages.map((msg, index) => `
                            <div class="mb-2 p-2 bg-white rounded">
                                <small class="text-muted">${index + 1}.</small> ${msg.substring(0, 100)}${msg.length > 100 ? '...' : ''}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-2">
                        <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Total messages: ${messages.length}</small>
                    </div>
                `;
            };
            reader.readAsText(file);
        });

        // Start sending messages
        async function startSending() {
            const userId = document.getElementById('sendUserId').value;
            const sessionId = document.getElementById('sessionSelect').value;
            const targetType = document.getElementById('targetType').value;
            const delaySec = document.getElementById('delaySeconds').value;
            const prefix = document.getElementById('messagePrefix').value;
            const fileInput = document.getElementById('messageFile');
            
            let target = '';
            let groupId = '';

            if (targetType === 'individual') {
                target = document.getElementById('targetNumber').value;
                if (!target) {
                    showAlert('Please enter target phone number', 'warning');
                    return;
                }
            } else {
                const selectedGroup = document.querySelector('.group-item.selected');
                if (!selectedGroup) {
                    showAlert('Please select a WhatsApp group', 'warning');
                    return;
                }
                groupId = selectedGroup.dataset.groupId;
                target = groupId;
            }

            if (!sessionId) {
                showAlert('Please select a WhatsApp session', 'warning');
                return;
            }

            if (!fileInput.files[0]) {
                showAlert('Please select a messages file', 'warning');
                return;
            }

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending Messages...';

            const formData = new FormData();
            formData.append('sessionId', sessionId);
            formData.append('target', target);
            formData.append('targetType', targetType);
            formData.append('delaySec', delaySec);
            formData.append('prefix', prefix);
            formData.append('userId', userId);
            formData.append('groupId', groupId);
            formData.append('messageFile', fileInput.files[0]);

            try {
                const response = await fetch('/send-message', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('sendStatus').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Message Task Started!</strong><br>
                            Task ID: <code>${data.taskId}</code><br>
                            Total Messages: ${data.totalMessages}<br>
                            <div class="mt-2">
                                <button class="btn btn-warning btn-sm" onclick="stopTask('${data.taskId}')">
                                    <i class="fas fa-stop me-1"></i>Stop This Task
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Switch to tasks tab
                    const tasksTab = new bootstrap.Tab(document.getElementById('tasks-tab'));
                    tasksTab.show();
                    
                    loadUserTasks();
                    
                    // Monitor task progress
                    monitorTaskProgress(data.taskId);
                } else {
                    document.getElementById('sendStatus').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-2"></i>
                            Error: ${data.error}
                        </div>
                    `;
                }

            } catch (error) {
                document.getElementById('sendStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>
                        Error: ${error.message}
                    </div>
                `;
            } finally {
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Start Sending Messages';
            }
        }

        // Monitor task progress
        async function monitorTaskProgress(taskId) {
            try {
                const response = await fetch(`/task-status?taskId=${taskId}`);
                const data = await response.json();
                
                if (data.status === 'sending') {
                    document.getElementById('sendStatus').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-sync-alt fa-spin me-2"></i>
                            <strong>Sending Messages...</strong><br>
                            Progress: ${data.sentMessages}/${data.totalMessages} (${data.progress}%)<br>
                            <div class="progress mt-2">
                                <div class="progress-bar" role="progressbar" style="width: ${data.progress}%;" 
                                     aria-valuenow="${data.progress}" aria-valuemin="0" aria-valuemax="100">
                                    ${data.progress}%
                                </div>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-warning btn-sm" onclick="stopTask('${taskId}')">
                                    <i class="fas fa-stop me-1"></i>Stop Task
                                </button>
                            </div>
                        </div>
                    `;
                    setTimeout(() => monitorTaskProgress(taskId), 3000);
                } else if (data.status === 'completed') {
                    document.getElementById('sendStatus').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Task Completed!</strong><br>
                            Successfully sent ${data.sentMessages}/${data.totalMessages} messages
                        </div>
                    `;
                    loadUserTasks();
                } else if (data.status === 'stopped') {
                    document.getElementById('sendStatus').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-stop-circle me-2"></i>
                            <strong>Task Stopped</strong><br>
                            Sent ${data.sentMessages}/${data.totalMessages} messages before stopping
                        </div>
                    `;
                    loadUserTasks();
                }
            } catch (error) {
                console.error('Error monitoring task:', error);
            }
        }

        // Stop task
        async function stopTask(taskId) {
            const userId = document.getElementById('sendUserId').value;
            
            try {
                const response = await fetch('/stop-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `taskId=${taskId}&userId=${userId}`
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('Message task stopped successfully', 'warning');
                    loadUserTasks();
                    document.getElementById('sendStatus').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Task stopped. Sent ${data.sentMessages}/${data.totalMessages} messages.
                        </div>
                    `;
                } else {
                    showAlert('Error stopping task: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('Error stopping task:', error);
                showAlert('Error stopping task', 'danger');
            }
        }

        // Load user tasks
        async function loadUserTasks() {
            const userId = document.getElementById('userId').value;
            if (!userId) return;

            try {
                const response = await fetch(`/user-tasks?userId=${userId}`);
                const data = await response.json();
                
                const tasksList = document.getElementById('tasksList');
                
                if (data.tasks.length === 0) {
                    tasksList.innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-tasks fa-3x mb-3 text-light" style="color: #e9ecef !important;"></i>
                            <p>No active message tasks</p>
                            <small class="text-muted">Your message sending tasks will appear here</small>
                        </div>
                    `;
                    return;
                }

                let tasksHTML = '';
                data.tasks.forEach(task => {
                    const statusClass = task.isSending ? 'status-connecting' : 'status-connected';
                    const statusText = task.isSending ? 'Sending...' : 'Completed';
                    const statusIcon = task.isSending ? 'fa-sync-alt fa-spin' : 'fa-check-circle';
                    
                    tasksHTML += `
                        <div class="card mb-3 task-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="card-title d-flex align-items-center">
                                            <i class="fas fa-tasks me-2 text-primary"></i>
                                            Task: ${task.taskId}
                                        </h6>
                                        <p class="card-text mb-2">
                                            <span class="${statusClass}">
                                                <i class="fas ${statusIcon} me-1"></i>${statusText}
                                            </span> 
                                            • Progress: ${task.sentMessages}/${task.totalMessages} messages
                                        </p>
                                        <div class="progress mb-2" style="width: 100%; max-width: 300px;">
                                            <div class="progress-bar" role="progressbar" style="width: ${task.progress}%;" 
                                                 aria-valuenow="${task.progress}" aria-valuemin="0" aria-valuemax="100">
                                                ${task.progress}%
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            Started: ${new Date(task.startTime).toLocaleString()}
                                        </small>
                                    </div>
                                    ${task.isSending ? `
                                        <div>
                                            <button class="btn btn-warning btn-sm" onclick="stopTask('${task.taskId}')">
                                                <i class="fas fa-stop me-1"></i>Stop
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                tasksList.innerHTML = tasksHTML;
                loadUserStats();

            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        // Load user stats
        async function loadUserStats() {
            const userId = document.getElementById('userId').value;
            if (!userId) return;

            try {
                const response = await fetch(`/user-stats?userId=${userId}`);
                const data = await response.json();
                
                document.getElementById('totalSessions').textContent = data.stats.activeSessions;
                document.getElementById('activeTasks').textContent = data.stats.activeTasks;
                document.getElementById('totalMessages').textContent = data.stats.totalMessagesSent;
                document.getElementById('userSince').textContent = new Date(data.stats.userSince).toLocaleDateString();

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Show alert message
        function showAlert(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to page (you can customize where to show alerts)
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Auto-refresh tasks every 10 seconds when on tasks tab
        setInterval(() => {
            if (document.getElementById('tasks-tab').classList.contains('active')) {
                loadUserTasks();
            }
        }, 10000);
    </script>
</body>
</html>
